<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>KAFFAHMEDIA SCANNER | Pro</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background: radial-gradient(circle at top right, #1e1b4b, #0f172a); }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .brand-font { font-family: 'Space Grotesk', sans-serif; letter-spacing: 0.1em; }
        .btn-gradient { background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); transition: all 0.3s ease; }
        .btn-gradient:hover { transform: translateY(-2px); box-shadow: 0 10px 20px -10px #6366f1; }
    </style>
</head>
<body class="text-slate-200 min-h-screen flex flex-col items-center p-4">

    <div class="max-w-md w-full mt-10">
        <div class="glass rounded-3xl shadow-2xl overflow-hidden mb-6">
            <div class="p-8">
                <header class="text-center mb-8">
                    <div class="inline-block p-3 bg-indigo-500/10 rounded-2xl mb-4">
                        <!-- simplified icon to avoid truncated path -->
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                    </div>
                    <h1 class="text-2xl font-bold tracking-tight text-white">Document Scanner</h1>
                    <p class="text-slate-400 text-sm mt-1">Konversi Cepat ke PDF Berkualitas</p>
                </header>

                <div id="input-container" class="mb-8">
                    <label for="imageInput" class="group cursor-pointer flex flex-col items-center justify-center border-2 border-dashed border-slate-700 hover:border-indigo-500 rounded-2xl p-8 transition-colors">
                        <div class="bg-indigo-500/10 p-4 rounded-full group-hover:bg-indigo-500/20 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                            </svg>
                        </div>
                        <span id="btn-text" class="mt-4 font-semibold text-slate-300">ðŸ“¸ Ambil Foto Dokumen</span>
                        <input type="file" id="imageInput" accept="image/*" class="hidden" />
                    </label>
                </div>

                <div id="crop-area" class="hidden mb-8 space-y-4">
                    <div class="relative rounded-2xl overflow-hidden bg-black border border-slate-700 shadow-inner">
                        <img id="image-to-crop" class="max-w-full block">
                    </div>
                    <div class="flex gap-2">
                        <button id="btn-bw" class="flex-1 bg-slate-800 hover:bg-slate-700 py-3 rounded-xl text-xs font-semibold border border-slate-700 transition-all">ðŸ”˜ B&W</button>
                        <button id="btn-color" class="flex-1 bg-slate-800 hover:bg-slate-700 py-3 rounded-xl text-xs font-semibold border border-slate-700 transition-all">ðŸŽ¨ HD COLOR</button>
                    </div>
                </div>

                <!-- Added preview container (was missing) -->
                <div id="previewContainer" class="mb-4 grid gap-3"></div>

                <button id="downloadBtn" class="hidden w-full btn-gradient text-white font-bold py-4 rounded-2xl shadow-xl flex items-center justify-center gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    UNDUH SEBAGAI PDF
                </button>
            </div>
        </div>

        <div class="text-center space-y-2 mb-10">
            <h2 class="brand-font text-lg font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-purple-400">
                KAFFAHMEDIA SCANNER
            </h2>
            <p class="text-[10px] text-slate-500 uppercase tracking-[0.2em]">Safe â€¢ Fast â€¢ Professional</p>
        </div>
    </div>

    <div class="mt-auto pb-6 flex items-center gap-2 text-slate-500 text-[11px] opacity-70">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
        </svg>
        Data diproses di perangkat. Privasi terjaga 100%.
    </div>

    <!-- Moved and fixed script: placed before closing body -->
    <script>
    const { jsPDF } = window.jspdf;
    const imageInput = document.getElementById('imageInput');
    const previewContainer = document.getElementById('previewContainer');
    const downloadBtn = document.getElementById('downloadBtn');
    const cropArea = document.getElementById('crop-area');
    const imageToCrop = document.getElementById('image-to-crop');
    const btnText = document.getElementById('btn-text');

    let imagesData = [];
    let cropper;

    // 1. Fungsi Penajam dengan Opsi Mode
    function prosesGambar(canvasInput, mode) {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = canvasInput.width;
        canvas.height = canvasInput.height;

        if (mode === 'bw') {
            ctx.filter = 'contrast(1.6) grayscale(1) brightness(1.1)';
        } else {
            ctx.filter = 'contrast(1.2) brightness(1.1) saturate(1.2)';
        }

        ctx.drawImage(canvasInput, 0, 0);
        return canvas.toDataURL('image/jpeg', 0.8);
    }

    // 2. Event saat pilih file
    imageInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                cropArea.classList.remove('hidden');
                imageToCrop.src = event.target.result;
                if (cropper) cropper.destroy();
                // ensure Cropper is defined (cdn script included above)
                cropper = new Cropper(imageToCrop, { viewMode: 1, autoCropArea: 0.9 });
                cropArea.scrollIntoView({ behavior: 'smooth' });
            };
            reader.readAsDataURL(file);
        }
    });

    // 3. Tombol Mode
    document.getElementById('btn-bw').addEventListener('click', () => selesaikanPotong('bw'));
    document.getElementById('btn-color').addEventListener('click', () => selesaikanPotong('color'));

    // 4. Fungsi Selesaikan Potong
    function selesaikanPotong(mode) {
        if (!cropper) return;

        const canvas = cropper.getCroppedCanvas({ maxWidth: 1600, maxHeight: 1600 });
        const hasilFinal = prosesGambar(canvas, mode);

        const currentIndex = imagesData.length;
        imagesData.push(hasilFinal);

        const wrapper = document.createElement('div');
        wrapper.className = "relative group rounded-lg overflow-hidden border border-slate-700 bg-slate-900/30 p-2";
        wrapper.id = `img-wrapper-${currentIndex}`;

        // Create image element
        const img = document.createElement('img');
        img.src = hasilFinal;
        img.className = "rounded w-full h-32 object-cover";

        // Create delete button
        const delBtn = document.createElement('button');
        delBtn.className = "absolute -top-2 -right-2 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs shadow-lg font-bold";
        delBtn.innerText = "âœ•";
        delBtn.type = "button";
        delBtn.onclick = () => hapusGambar(currentIndex);

        // Append children
        wrapper.appendChild(img);
        wrapper.appendChild(delBtn);
        previewContainer.appendChild(wrapper);

        cropper.destroy();
        cropper = null; // Reset cropper
        cropArea.classList.add('hidden');
        downloadBtn.classList.remove('hidden');
        if (btnText) btnText.innerText = "âž• Tambah Halaman Lagi";
        imageInput.value = "";
    }

    // 5. Fungsi Hapus Gambar
    window.hapusGambar = function(index) {
        imagesData[index] = null;
        const element = document.getElementById(`img-wrapper-${index}`);
        if (element) element.remove();

        const sisaGambar = imagesData.filter(img => img !== null);
        if (sisaGambar.length === 0) {
            downloadBtn.classList.add('hidden');
            if (btnText) btnText.innerText = "ðŸ“¸ Ambil Foto Dokumen";
        }
    }

    // 6. Fungsi Download PDF
    downloadBtn.addEventListener('click', function() {
        const pdf = new jsPDF();
        const validImages = imagesData.filter(img => img !== null);

        validImages.forEach((data, index) => {
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();

            if (index > 0) pdf.addPage();
            pdf.addImage(data, 'JPEG', 10, 10, pageWidth - 20, pageHeight - 40);

            pdf.setFontSize(10);
            pdf.setTextColor(150);
            const wm = "Scanned by Kaffah Media Scanner";
            pdf.text(wm, (pageWidth - pdf.getTextWidth(wm)) / 2, pageHeight - 15);
        });

        pdf.save("Kaffah_Scanner_" + Date.now() + ".pdf");
    });
    </script>

</body>
</html>
